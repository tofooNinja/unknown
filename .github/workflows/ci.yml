name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  check:
    name: Nix Flake Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Setup SSH for private inputs
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.NIX_SECRETS_DEPLOY_KEY }}

      - name: Check flake
        run: nix flake check --no-build

  eval:
    name: Evaluate NixOS Configurations
    runs-on: ubuntu-latest
    strategy:
      matrix:
        configuration:
          - space
          - black
          - metal-nvidia
          - metal-wayland
          - deck
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Setup SSH for private inputs
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.NIX_SECRETS_DEPLOY_KEY }}

      - name: Evaluate ${{ matrix.configuration }}
        run: |
          nix eval .#nixosConfigurations.${{ matrix.configuration }}.config.system.build.toplevel.drvPath

  format-check:
    name: Check Formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Format with nixpkgs-fmt
        run: |
          nix develop --command nixpkgs-fmt .

      - name: Check for formatting changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate formatting patch
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git diff > formatting.patch
          echo "::group::Formatting patch (apply with: git apply formatting.patch)"
          cat formatting.patch
          echo "::endgroup::"
          echo ""
          echo "To fix formatting locally, run:"
          echo "  nix develop --command nixpkgs-fmt ."
          echo ""
          echo "Or download and apply the patch artifact:"
          echo "  git apply formatting.patch"

      - name: Upload formatting patch
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: formatting-patch
          path: formatting.patch

      - name: Fail if formatting needed
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          echo "::error::Files need formatting. See the patch above or download the artifact."
          exit 1
